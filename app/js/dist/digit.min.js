function cross(n,e){var i=[];return _.each(n,function(n){_.each(e,function(e){i.push(n+e)})}),i}function parse_grid(n){var e=_.object(_.map(S.squares,function(n){return[n,S.digits]}));return _.each(grid_values(n),function(n,i){return-1===S.digits.indexOf(n)||assign(e,i,n)?void 0:!1}),e}function parse_grid_no_cp(n){var e=_.object(_.map(S.squares,function(n){return[n,S.digits]}));return _.each(grid_values(n),function(n,i){return-1===S.digits.indexOf(n)||assign_no_cp(e,i,n)?void 0:!1}),e}function to_grid(n){return _.map(_.values(n),function(n){return n.length>1?".":n}).join("")}function grid_values(n){return _.object(_.map(_.filter(n,function(n){return-1!==(S.digits+"0.").indexOf(n)}),function(n,e){return[S.squares[e],n]}))}function assign_no_cp(n,e,i){return n[e]=i,n}function assign(n,e,i){var t=n[e].replace(i,"");return _.every(t,function(i){return eliminate(n,e,i)})?n:!1}function eliminate(n,e,i){if(-1===n[e].indexOf(i))return n;if(n[e]=n[e].replace(i,""),0===n[e].length)return!1;if(1===n[e].length){var t=n[e];if(!_.every(S.peers[e],function(e){return eliminate(n,e,t)}))return!1}for(var r=0;r<S.units[e].length;r++){var u=_.filter(S.units[e][r],function(e){return-1!==n[e].indexOf(i)});if(0===u.length)return!1;if(1==u.length&&!assign(n,u[0],i))return!1}return n}function display(n){var e=1+_.max(n,function(n){return n.length}).length,i=[];_.times(3,function(){i.push(Array(3*e+1).join("-"))}),i=i.join("+"),_.each(S.rows,function(t){console.log(_.map(S.cols,function(i){return _.str.center(n[t+i],e)+(-1!=="36".indexOf(i)?"|":"")}).join("")),-1!=="CF".indexOf(t)&&console.log(i)})}function search(n){if(!n)return!1;if(_.every(S.squares,function(e){return 1===n[e].length}),_.every(S.squares,function(e){return 1===n[e].length}))return n;for(var e=_.min(_.filter(S.squares,function(e){return n[e].length>1}),function(e){return n[e].length}),i=0;i<n[e].length;i++){var t=search(assign(_.clone(n),e,n[e].charAt(i)));if(t)return t}return!1}function solve(n){return display(search(parse_grid(n)))}function random_puzzle(n){n=n||17;var e={};_.each(S.squares,function(n){e[n]=S.digits});for(var i=_.shuffle(S.squares),t=0;t<i.length;t++){var r=i[t];if(!assign(e,r,_.sample(e[r])))break;var u=_.map(_.filter(S.squares,function(n){return 1===e[n].length}),function(n){return e[n]});if(u.length>=n&&_.uniq(u).length>=8)return _.map(S.squares,function(n){return 1===e[n].length?e[n]:"."}).join("")}return random_puzzle(n)}var S={};S.grid1="003020600900305001001806400008102900700000008006708200002609500800203009005010300",S.grid2="4.....8.5.3..........7......2.....6.....8.4......1.......6.3.7.5..2.....1.4......",S.wikigrid="53..7....6..195....98....6.8...6...34..8.3..17...2...6.6....28....419..5....8..79",S.digits="123456789",S.rows="ABCDEFGHI",S.rowss=["ABC","DEF","GHI"],S.cols=S.digits,S.colss=["123","456","789"],S.squares=cross(S.rows,S.cols),S.unitlist=[],_.each(S.cols,function(n){S.unitlist.push(cross(S.rows,n))}),_.each(S.rows,function(n){S.unitlist.push(cross(n,S.cols))}),_.each(S.rowss,function(n){_.each(S.colss,function(e){S.unitlist.push(cross(n,e))})}),S.units={},_.each(S.squares,function(n){S.units[n]=_.filter(S.unitlist,function(e){return _.contains(e,n)})}),S.peers={},_.each(S.squares,function(n){S.peers[n]=_.uniq(_.without(_.flatten(S.units[n]),n))});var digit=angular.module("digit",[]);digit.value("S",S),digit.filter("hideifmany",function(){return function(n){return n.length>1?"":n}}),digit.controller("DigitCtrl",["$scope","$timeout","S",function(n,e,i){n.S=i,n.init_puzzle=parse_grid_no_cp(i.wikigrid),n.puzzle=angular.copy(n.init_puzzle),n.active_peers=[],n.init_moment=moment(),n.elapsed_time=0;var t;n.new_puzzle=function(){var e=random_puzzle();n.init_puzzle=parse_grid_no_cp(e),n.puzzle=angular.copy(n.init_puzzle),n.init_moment=moment(),n.tick()},n.solve=function(){n.puzzle=search(parse_grid(to_grid(n.init_puzzle))),n.solved_by_machine=!0,e.cancel(t)},n.tick=function(){var i=moment().diff(n.init_moment),r=moment.duration(i);n.elapsed_time=[_.str.pad(r.hours(),2,"0"),_.str.pad(r.minutes(),2,"0"),_.str.pad(r.seconds(),2,"0")].join(":"),t=e(n.tick,1e3)},n.is_filled=function(){return _.every(n.puzzle,function(n){return 1===n.length})},n.check=function(){return n.is_filled()&&(n.solution=search(parse_grid(to_grid(n.puzzle))),to_grid(n.puzzle)===to_grid(n.solution))?(e.cancel(t),!0):void 0},n.rotate=function(e){if(n.active_peers=i.peers[e],1!==n.init_puzzle[e].length){for(var t=_.uniq(_.filter(_.map(i.peers[e],function(e){return n.init_puzzle[e]}),function(n){return 1===n.length})),r=n.puzzle[e].length>1?1:1+ +n.puzzle[e]%9;-1!=t.indexOf(r.toString());)r=1+r%9;assign_no_cp(n.puzzle,e,r.toString())}},n.highlight_peers=function(e){n.active_peers=i.peers[e]},n.tick()}]);